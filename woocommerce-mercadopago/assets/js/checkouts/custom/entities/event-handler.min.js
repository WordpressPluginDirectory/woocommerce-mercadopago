class MPEventHandler{REMOVE_LOAD_SPINNER_DELAY=500;constructor(e,o){this.cardForm=e,this.threeDSHandler=o,this.triggeredPaymentMethodSelectedEvent=!1,this.mercado_pago_submit=!1,this.hasToken=!1,this.mpFormId="checkout"}bindEvents(){jQuery("form.checkout").on("checkout_place_order_woo-mercado-pago-custom",((e,o)=>this.mercadoPagoFormHandler(e,o))),jQuery("body").on("payment_method_selected",this.handlePaymentMethodSelected.bind(this)),jQuery("form#order_review").submit(this.handleOrderReviewSubmit.bind(this)),jQuery(document.body).on("checkout_error",this.handleCheckoutError.bind(this)),jQuery(document).on("updated_checkout",this.handleUpdatedCheckout.bind(this)),jQuery(document).ready((()=>{this.threeDSHandler.set3dsStatusValidationListener(),wc_mercadopago_custom_event_handler_params.is_mobile||this.initCardFormWhenReady()}))}initCardFormWhenReady(){const e=document.querySelector(".mp-checkout-custom-container"),o=document.querySelector("#payment_method_woo-mercado-pago-custom");o?.checked&&null!==e?.offsetParent&&this.cardForm.initCardForm()}showCheckoutClassicLoader(){jQuery("form.checkout")?.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}hideCheckoutClassicLoader(){jQuery("form.checkout")?.unblock()}mercadoPagoFormHandler(e,o){return this.setMercadoPagoSessionId(),window.mpSuperTokenPaymentMethods?.hideSuperTokenError(),!!this.mercado_pago_submit||("wallet_button"===jQuery("#mp_checkout_type").val()||("super_token"===jQuery("#mp_checkout_type").val()?(window.mpSuperTokenMetrics?.registerClickOnPlaceOrderButton(),!!this.hasWooCommerceValidationErrors()||(this.handleWithSuperTokenSubmit(e,o),!1)):(jQuery("#mp_checkout_type").val("custom"),!this.hasToken&&(this.setPayerIdentificationInfo(),this.createToken()))))}async handleWithSuperTokenSubmit(e,o){try{e.preventDefault(),this.showCheckoutClassicLoader();const r=window.mpSuperTokenPaymentMethods,t=window.mpSuperTokenAuthenticator;if(!r)throw new Error(MPSuperTokenErrorCodes.SUPER_TOKEN_PAYMENT_METHODS_NOT_FOUND);if(!t)throw new Error(MPSuperTokenErrorCodes.SUPER_TOKEN_AUTHENTICATOR_NOT_FOUND);const i=r.getActivePaymentMethod(),n=i&&r.isSelectedPaymentMethodValid();if(!i)throw new Error(MPSuperTokenErrorCodes.SELECT_PAYMENT_METHOD_ERROR);if(!n)throw new Error(MPSuperTokenErrorCodes.SELECT_PAYMENT_METHOD_NOT_VALID);await t.authorizePayment(i.token),await r.updateSecurityCode(),this.mercado_pago_submit=!0,o.$checkout_form.trigger("submit")}catch(e){window.mpSuperTokenErrorHandler?.handleError(e),this.cardForm.removeLoadSpinner(),this.hideCheckoutClassicLoader()}}isInsideHiddenContainer(e){const o=[".shipping_address",".billing_address",".woocommerce-shipping-fields",".woocommerce-billing-fields",".form-row"];for(const r of o){const o=e.closest(r);if(o&&"none"===window.getComputedStyle(o).display)return!0}return!1}hasWooCommerceValidationErrors(){const e=document.querySelectorAll(".woocommerce-invalid, .woocommerce-invalid-required-field, .validate-required.woocommerce-invalid"),o=Array.from(e).filter((e=>!this.isInsideHiddenContainer(e))),r=document.querySelectorAll(".woocommerce-checkout .validate-required input, .woocommerce-checkout .validate-required select"),t=Array.from(r).some((e=>"hidden"!==e.type&&!e.disabled&&(!this.isInsideHiddenContainer(e)&&!e.value.trim())));return o.length>0||t}createToken(){return"undefined"==typeof CheckoutPage||"function"!=typeof CheckoutPage.verifyInstallmentsContainer||CheckoutPage.verifyInstallmentsContainer()?(this.cardForm.form.createCardToken().then((e=>{if(!e.token)throw new Error("cardToken is empty");if(!this.hasToken)return document.querySelector("#cardTokenId").value=e.token,this.mercado_pago_submit=!0,this.hasToken=!0,"order_review"===this.mpFormId?(this.handle3dsPayOrderFormSubmission(),!1):void jQuery("form.checkout").submit()})).catch((e=>{console.warn("Token creation error: ",e),this.cardForm.scrollToCardForm(),this.cardForm.removeLoadSpinner()})),!1):(this.cardForm.removeLoadSpinner(),!1)}setMercadoPagoSessionId(){if("undefined"!=typeof MP_DEVICE_SESSION_ID&&MP_DEVICE_SESSION_ID)try{document.querySelector("#mpCardSessionId").value=MP_DEVICE_SESSION_ID}catch(e){console.warn(e)}}isCheckoutCustomPaymentMethodSelected(){const e=document.getElementById("payment_method_woo-mercado-pago-custom")||document.querySelector("input[value=woo-mercado-pago-custom]");return e&&e.checked}handlePaymentMethodSelected(){this.isCheckoutCustomPaymentMethodSelected()||this.cardForm.formMounted&&this.cardForm.form.unmount()}handleOrderReviewSubmit(e){if(this.isCheckoutCustomPaymentMethodSelected())return e.preventDefault(),this.mercadoPagoFormHandler();this.cardForm.formMounted&&this.cardForm.form.unmount()}handleCheckoutError(){this.hasToken=!1,this.mercado_pago_submit=!1,this.cardForm.removeLoadSpinner(),window.mpSuperTokenTriggerHandler?.resetSuperTokenOnError()}handleUpdatedCheckout(){if(this.isCheckoutCustomPaymentMethodSelected()){this.cardForm.createLoadSpinner();const e=this.cardForm.getAmount(),o=this.cardForm.amount,r=[window.mpSuperTokenTriggerHandler?.loadSuperToken(e)];this.cardForm.formMounted&&e!==o&&this.cardForm.form.unmount(),this.cardForm.formMounted||r.push(this.cardForm.initCardForm()),Promise.all(r).finally((()=>{setTimeout((()=>this.cardForm.removeLoadSpinner()),this.REMOVE_LOAD_SPINNER_DELAY)}))}}handle3dsPayOrderFormSubmission(){var e=jQuery("#order_review").serialize();jQuery.post("#",e).done((e=>{if(e.three_ds_flow)this.threeDSHandler.load3DSFlow(e.last_four_digits);else{if("success"!==e.result||!e.redirect)return"fail"===e.result?(jQuery("#order_review .woocommerce-error, #order_review .woocommerce-message").remove(),jQuery("#order_review").prepend('<div class="woocommerce-error">'+e.messages+"</div>"),this.cardForm.removeBlockOverlay(),this.cardForm.removeLoadSpinner(),this.hasToken=!1,void(this.mercado_pago_submit=!1)):void window.location.reload();window.location.href=e.redirect}})).error((()=>{window.location.reload()}))}setPayerIdentificationInfo(){[{selector:"#form-checkout__identificationType",hiddenInputId:"#payerDocType"},{selector:"#form-checkout__identificationNumber",hiddenInputId:"#payerDocNumber"}].forEach((({selector:e,hiddenInputId:o})=>{const r=document.querySelector(e),t=document.querySelector(o);r&&t&&r.value&&(t.value=r.value)}))}}