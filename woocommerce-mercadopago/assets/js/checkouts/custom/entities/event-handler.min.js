class MPEventHandler{constructor(e,o){this.cardForm=e,this.threeDSHandler=o,this.triggeredPaymentMethodSelectedEvent=!1,this.mercado_pago_submit=!1,this.hasToken=!1,this.mpFormId="checkout"}bindEvents(){jQuery("form.checkout").on("checkout_place_order_woo-mercado-pago-custom",((e,o)=>this.mercadoPagoFormHandler(e,o))),jQuery("body").on("payment_method_selected",this.handlePaymentMethodSelected.bind(this)),jQuery("form#order_review").submit(this.handleOrderReviewSubmit.bind(this)),jQuery(document.body).on("checkout_error",this.handleCheckoutError.bind(this)),jQuery(document).on("updated_checkout",this.handleUpdatedCheckout.bind(this)),jQuery(document).ready((()=>{this.setCardFormLoadInterval(),this.threeDSHandler.set3dsStatusValidationListener()}))}showCheckoutClassicLoader(){jQuery("form.checkout")?.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}hideCheckoutClassicLoader(){jQuery("form.checkout")?.unblock()}mercadoPagoFormHandler(e,o){return this.setMercadoPagoSessionId(),!!this.mercado_pago_submit||("wallet_button"===jQuery("#mp_checkout_type").val()||("super_token"===jQuery("#mp_checkout_type").val()?(e.preventDefault(),this.showCheckoutClassicLoader(),this.mercado_pago_submit?(this.mercado_pago_submit=!1,!0):!!window.mpSuperTokenPaymentMethods&&(window.mpSuperTokenPaymentMethods.isSelectedPaymentMethodValid()?(window.mpSuperTokenPaymentMethods.updateSecurityCode().then((()=>{this.mercado_pago_submit=!0,o.$checkout_form.trigger("submit")})).catch((()=>(this.cardForm.removeLoadSpinner(),this.hideCheckoutClassicLoader(),!1))),!1):(window.mpSuperTokenPaymentMethods.forceShowValidationErrors(),this.cardForm.removeLoadSpinner(),this.hideCheckoutClassicLoader(),!1))):(jQuery("#mp_checkout_type").val("custom"),!this.hasToken&&(this.setPayerIdentificationInfo(),this.createToken()))))}createToken(){return"undefined"==typeof CheckoutPage||"function"!=typeof CheckoutPage.verifyInstallmentsContainer||CheckoutPage.verifyInstallmentsContainer()?(this.cardForm.form.createCardToken().then((e=>{if(!e.token)throw new Error("cardToken is empty");if(!this.hasToken)return document.querySelector("#cardTokenId").value=e.token,this.mercado_pago_submit=!0,this.hasToken=!0,"order_review"===this.mpFormId?(this.handle3dsPayOrderFormSubmission(),!1):void jQuery("form.checkout").submit()})).catch((e=>{console.warn("Token creation error: ",e),this.cardForm.removeLoadSpinner()})),!1):(this.cardForm.removeLoadSpinner(),!1)}setMercadoPagoSessionId(){if("undefined"!=typeof MP_DEVICE_SESSION_ID&&MP_DEVICE_SESSION_ID)try{document.querySelector("#mpCardSessionId").value=MP_DEVICE_SESSION_ID}catch(e){console.warn(e)}}isCheckoutCustomPaymentMethodSelected(){const e=document.getElementById("payment_method_woo-mercado-pago-custom")||document.querySelector("input[value=woo-mercado-pago-custom]");return e&&e.checked}setCardFormLoadInterval(){var e=setInterval((()=>{const o=document.getElementById("form-checkout__cardNumber-container");this.isCheckoutCustomPaymentMethodSelected()?o&&o.childElementCount>0?clearInterval(e):(this.cardForm.formMounted&&this.cardForm.form.unmount(),this.cardForm.initCardForm()):clearInterval(e)}),1500)}handlePaymentMethodSelected(){this.isCheckoutCustomPaymentMethodSelected()?(this.cardForm.createLoadSpinner(),this.triggeredPaymentMethodSelectedEvent||this.cardForm.initCardForm()):this.cardForm.formMounted&&this.cardForm.form.unmount()}handleOrderReviewSubmit(e){if(this.isCheckoutCustomPaymentMethodSelected())return e.preventDefault(),this.cardForm.createLoadSpinner(),this.mercadoPagoFormHandler();this.cardForm.formMounted&&this.cardForm.form.unmount()}handleCheckoutError(){this.hasToken=!1,this.mercado_pago_submit=!1,this.cardForm.removeLoadSpinner(),window.mpSuperTokenTriggerHandler?.resetSuperTokenOnError()}handleUpdatedCheckout(){this.isCheckoutCustomPaymentMethodSelected()&&(this.cardForm.formMounted&&this.cardForm.form.unmount(),this.cardForm.initCardForm())}handle3dsPayOrderFormSubmission(){var e=jQuery("#order_review").serialize();jQuery.post("#",e).done((e=>{if(e.three_ds_flow)this.threeDSHandler.load3DSFlow(e.last_four_digits);else{if("success"!==e.result||!e.redirect)return"fail"===e.result?(jQuery("#order_review .woocommerce-error, #order_review .woocommerce-message").remove(),jQuery("#order_review").prepend('<div class="woocommerce-error">'+e.messages+"</div>"),this.cardForm.removeBlockOverlay(),this.cardForm.removeLoadSpinner(),this.hasToken=!1,void(this.mercado_pago_submit=!1)):void window.location.reload();window.location.href=e.redirect}})).error((()=>{window.location.reload()}))}setPayerIdentificationInfo(){[{selector:"#form-checkout__identificationType",hiddenInputId:"#payerDocType"},{selector:"#form-checkout__identificationNumber",hiddenInputId:"#payerDocNumber"}].forEach((({selector:e,hiddenInputId:o})=>{const r=document.querySelector(e),t=document.querySelector(o);r&&t&&r.value&&(t.value=r.value)}))}}