class MPSuperTokenTriggerHandler{CUSTOM_CHECKOUT_BLOCKS_RADIO_SELECTOR="[value=woo-mercado-pago-custom]";CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR="#payment_method_woo-mercado-pago-custom";CUSTOM_CHECKOUT_CLASSIC_SELECTOR=".payment_method_woo-mercado-pago-custom";CUSTOM_CHECKOUT_CONTAINER_ID="mp-custom-checkout-form-container";CLICKABLE_AREA_CLASS="mp-super-token-clickable-area";CARD_NUMBER_FIELD_ID="form-checkout__cardNumber-container";CARD_HOLDER_NAME_FIELD_ID="form-checkout__cardholderName";EXPIRATION_DATE_FIELD_ID="form-checkout__expirationDate-container";SECURITY_CODE_FIELD_ID="form-checkout__securityCode-container";CURRENT_USER_EMAIL=wc_mercadopago_supertoken_trigger_handler_params.current_user_email;wcBuyerEmail=null;currentAmount=null;isAlreadyListeningForm=!1;isAuthenticating=!1;mpSuperTokenAuthenticator=null;wcEmailListener=null;mpSuperTokenPaymentMethods=null;constructor(e,t,r){this.mpSuperTokenAuthenticator=e,this.wcEmailListener=t,this.mpSuperTokenPaymentMethods=r}reset(){this.removeClickableAreas(),this.isAuthenticating=!1}amountHasChanged(){return null!=this.currentAmount&&null!=this.mpSuperTokenAuthenticator.getAmountUsed()&&this.currentAmount!==this.mpSuperTokenAuthenticator.getAmountUsed()}isDifferentEmail(e){return this.wcBuyerEmail!=e}getCustomCheckoutRadioElement(){return document.querySelector(this.CUSTOM_CHECKOUT_BLOCKS_RADIO_SELECTOR)||document.querySelector(this.CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR)}isClassicCheckout(){return!!document.querySelector(this.CUSTOM_CHECKOUT_CLASSIC_SELECTOR)}getAmount(){const e=this.getCartTotalFromHTML();if(e)return e;const t=document.getElementById("mp-amount");if(!t)return null;const r=parseFloat(t?.value?.replace(",",".")).toFixed(2);return String(r)}getCartTotalFromHTML(){const e=document.querySelector(".wc-block-components-totals-wrapper .wc-block-components-totals-item__value .wc-block-components-formatted-money-amount");if(!e||!e?.textContent)return null;const t=e.textContent.replace(/[^\d.,]/g,"");if(!/,\d{2}$/.test(t))return null;const r=parseFloat(t.replace(/\./g,"").replace(",","."));return r?.toFixed(2)}customCheckoutIsEnable(){return!!this.getCustomCheckoutRadioElement()}customCheckoutIsActive(){return this.getCustomCheckoutRadioElement()?.checked}alreadyHasClickableArea(){return!!document.querySelector(`.${this.CLICKABLE_AREA_CLASS}`)}shouldCreateClickableArea(){return this.customCheckoutIsActive()&&!this.alreadyHasClickableArea()}getMercadoPagoCustomCheckoutContainerElement(){return document.getElementById(this.CUSTOM_CHECKOUT_CONTAINER_ID)}getCreditCardFormFields(){return[document.getElementById(this.CARD_NUMBER_FIELD_ID),document.getElementById(this.CARD_HOLDER_NAME_FIELD_ID),document.getElementById(this.EXPIRATION_DATE_FIELD_ID),document.getElementById(this.SECURITY_CODE_FIELD_ID)]}createClickableArea(e){const t=e.parentElement;t.addEventListener("click",this.onTrigger.bind(this),{once:!0}),t.classList.add(this.CLICKABLE_AREA_CLASS),e.style.pointerEvents="none",e.classList.add("mp-pointer-events-none")}removeClickableAreas(){document.querySelectorAll(`.${this.CLICKABLE_AREA_CLASS}`).forEach((e=>{const t=e.querySelector(".mp-pointer-events-none");t.style.pointerEvents="auto",t.classList.remove("mp-pointer-events-none"),e.classList.remove(this.CLICKABLE_AREA_CLASS),e.removeEventListener("click",this.onTrigger.bind(this))}))}onTrigger(){if(this.isAuthenticating||!this.alreadyHasClickableArea())return;this.isAuthenticating=!0;const e=this.wcBuyerEmail||this.wcEmailListener.getEmail()||this.CURRENT_USER_EMAIL;if(!e)return this.isAuthenticating=!1,void this.removeClickableAreas();this.mpSuperTokenAuthenticator.authenticate(this.currentAmount,e).finally((()=>{this.isAuthenticating=!1,this.removeClickableAreas()}))}resetFlow(){this.reset(),this.mpSuperTokenAuthenticator.reset(),this.mpSuperTokenPaymentMethods.reset()}resetCustomCheckout(){this.mpSuperTokenPaymentMethods.hasStoredPaymentMethods()&&(this.mpSuperTokenPaymentMethods.unmountCardForm(),this.mpSuperTokenPaymentMethods.mountCardForm()),this.resetFlow(),this.loadSuperToken(this.getAmount())}resetSuperTokenOnError(){"super_token"===document.querySelector("#mp_checkout_type")?.value&&(this.resetCustomCheckout(),this.isAuthenticating=!1,document.querySelector("#mp_checkout_type").value="")}isSuperTokenPaymentMethodsLoaded(){return this.mpSuperTokenPaymentMethods.hasStoredPaymentMethods()}async loadSuperToken(e=this.getAmount()){this.mpSuperTokenAuthenticator.isUserClosedModal()||(this.currentAmount=e,this.amountHasChanged()&&this.resetFlow(),this.isSuperTokenPaymentMethodsLoaded()?this.mpSuperTokenPaymentMethods.renderAccountPaymentMethods(this.mpSuperTokenPaymentMethods.getStoredPaymentMethods()):(this.shouldCreateClickableArea()&&this.getCreditCardFormFields().forEach((e=>{this.createClickableArea(e)})),this.isAlreadyListeningForm||(this.wcEmailListener.onEmailChange((async(t,r)=>{if(!r||!e)return;this.isDifferentEmail(t)&&null!=this.wcBuyerEmail&&this.resetCustomCheckout(),this.wcBuyerEmail=t;await this.mpSuperTokenAuthenticator.canUseSuperTokenFlow(e,t)||this.removeClickableAreas()})),this.wcEmailListener.setupEmailChangeHandlers(),this.isAlreadyListeningForm=!0)))}}