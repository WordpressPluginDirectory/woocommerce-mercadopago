class MPSuperTokenTriggerHandler{CUSTOM_CHECKOUT_BLOCKS_RADIO_SELECTOR="[value=woo-mercado-pago-custom]";CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR="#payment_method_woo-mercado-pago-custom";FORM_CHECKOUT_SELECTOR="form.checkout, form#order_review";CHECKOUT_TYPE_SELECTOR="#mp_checkout_type";WALLET_BUTTON_CONTAINER_SELECTOR=".mp-wallet-button-container";WALLET_BUTTON_OPTION_VALUE="wallet_button";CURRENT_USER_EMAIL=wc_mercadopago_supertoken_trigger_handler_params.current_user_email;WALLET_BUTTON_ENABLED=wc_mercadopago_supertoken_trigger_handler_params.wallet_button_enabled;wcBuyerEmail=null;currentAmount=null;isAlreadyListeningForm=!1;mpSuperTokenAuthenticator=null;wcEmailListener=null;mpSuperTokenPaymentMethods=null;mpSuperTokenTriggerFieldsStrategy=null;constructor(e,t,o,n){this.mpSuperTokenAuthenticator=e,this.wcEmailListener=t,this.mpSuperTokenPaymentMethods=o,this.mpSuperTokenTriggerFieldsStrategy=n}walletButtonIsActive(){return this.WALLET_BUTTON_ENABLED}getBuyerEmail(){return this.wcBuyerEmail=this.wcBuyerEmail||this.wcEmailListener.getEmail()||this.CURRENT_USER_EMAIL,this.wcBuyerEmail}amountHasChanged(){return null!=this.currentAmount&&null!=this.mpSuperTokenAuthenticator.getAmountUsed()&&this.currentAmount!==this.mpSuperTokenAuthenticator.getAmountUsed()}isDifferentEmail(e){return this.wcBuyerEmail!=e}getCustomCheckoutRadioElement(){return document.querySelector(this.CUSTOM_CHECKOUT_BLOCKS_RADIO_SELECTOR)||document.querySelector(this.CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR)}isClassicCheckout(){return!!document.querySelector(this.CUSTOM_CHECKOUT_CLASSIC_SELECTOR)}getAmount(){const e=this.getCartTotalFromHTML();if(e)return e;const t=document.getElementById("mp-amount");return t?this.mpSuperTokenAuthenticator.formatAmount(t.value):null}getCartTotalFromHTML(){const e=document.querySelector(".wc-block-components-totals-wrapper .wc-block-components-totals-item__value .wc-block-components-formatted-money-amount");if(!e||!e?.textContent)return null;const t=e.textContent.replace(/[^\d.,]/g,"");if(!/,\d{2}$/.test(t))return null;const o=parseFloat(t.replace(/\./g,"").replace(",","."));return o?.toFixed(2)}customCheckoutIsEnable(){return!!this.getCustomCheckoutRadioElement()}customCheckoutIsActive(){return this.getCustomCheckoutRadioElement()?.checked}onTriggerWalletButton(e=null){const t=()=>{document.dispatchEvent(new CustomEvent("mp_wallet_button_submitted")),jQuery(this.CHECKOUT_TYPE_SELECTOR).val(this.WALLET_BUTTON_OPTION_VALUE),e?e():jQuery(this.FORM_CHECKOUT_SELECTOR).submit()},o=this.getBuyerEmail();o&&(!this.mpSuperTokenAuthenticator.emailAlreadyVerified()||this.mpSuperTokenAuthenticator.isAbleToUseSuperToken())?this.mpSuperTokenAuthenticator.authenticate(this.currentAmount,o,{confirmationLocation:"app",skipAllUserConfirmation:!0}).catch((()=>{t()})):t()}resetFlow(){this.mpSuperTokenAuthenticator.reset(),this.mpSuperTokenPaymentMethods.reset()}resetCustomCheckout(){window.mpCustomCheckoutHandler?.cardForm?.createLoadSpinner(),this.mpSuperTokenPaymentMethods.hasStoredPaymentMethods()&&(this.mpSuperTokenPaymentMethods.unmountCardForm(),this.mpSuperTokenPaymentMethods.mountCardForm()),this.resetFlow(),this.loadSuperToken(this.getAmount()).finally((()=>{setTimeout((()=>{window.mpCustomCheckoutHandler?.cardForm?.removeLoadSpinner()}),500)}))}resetSuperTokenOnError(){"super_token"===document.querySelector("#mp_checkout_type")?.value&&(this.resetCustomCheckout(),document.querySelector("#mp_checkout_type").value="")}isSuperTokenPaymentMethodsLoaded(){return this.mpSuperTokenPaymentMethods.hasStoredPaymentMethods()}onSelectPreloadedPaymentMethod=async(e,t)=>{this.mpSuperTokenPaymentMethods.hidePaymentMethodsList(),window.mpCustomCheckoutHandler?.cardForm?.createLoadSpinner(),this.mpSuperTokenPaymentMethods.reset(),this.mpSuperTokenPaymentMethods.emitEventFromSelectPaymentMethod(t),this.mpSuperTokenPaymentMethods.storeSelectedPreloadedPaymentMethod(t),await this.mpSuperTokenAuthenticator.showAuthenticatorWithPreloadedPaymentMethods(),window.mpCustomCheckoutHandler?.cardForm?.removeLoadSpinner(),this.mpSuperTokenPaymentMethods.showPaymentMethodsList()};async _loadSuperTokenPaymentMethodsPreview(){const e=this.getBuyerEmail();if(!e)return;const t=await this.mpSuperTokenAuthenticator.getPreloadedPaymentMethods(this.currentAmount,e);t&&t.length&&await this.mpSuperTokenPaymentMethods.renderPreloadedPaymentMethods(t,this.onSelectPreloadedPaymentMethod)}async loadSuperToken(e=this.getAmount()){this.mpSuperTokenAuthenticator.isUserClosedModal()||(this.currentAmount=this.mpSuperTokenAuthenticator.formatAmount(e),this.amountHasChanged()&&!this.walletButtonIsActive()&&this.resetFlow(),this.isSuperTokenPaymentMethodsLoaded()?this.mpSuperTokenPaymentMethods.renderAccountPaymentMethods(this.mpSuperTokenPaymentMethods.getStoredPaymentMethods()):(this.walletButtonIsActive()&&await this._loadSuperTokenPaymentMethodsPreview(),this.walletButtonIsActive()||this.mpSuperTokenTriggerFieldsStrategy.createClickableAreaListeners(this.currentAmount,this.getBuyerEmail()),this.isAlreadyListeningForm||(this.wcEmailListener.onEmailChange((async(t,o)=>{o&&e&&(this.isDifferentEmail(t)&&null!=this.wcBuyerEmail&&(this.wcBuyerEmail=t,this.resetCustomCheckout()),this.walletButtonIsActive()||await this.mpSuperTokenAuthenticator.canUseSuperTokenFlow(e,t))})),this.wcEmailListener.setupEmailChangeHandlers(),this.isAlreadyListeningForm=!0)))}}