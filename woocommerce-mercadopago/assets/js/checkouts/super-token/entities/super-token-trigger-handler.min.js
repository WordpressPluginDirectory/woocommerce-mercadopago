class MPSuperTokenTriggerHandler{CUSTOM_CHECKOUT_BLOCKS_RADIO_SELECTOR="[value=woo-mercado-pago-custom]";CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR="#payment_method_woo-mercado-pago-custom";FORM_CHECKOUT_SELECTOR="form.checkout, form#order_review";CHECKOUT_TYPE_SELECTOR="#mp_checkout_type";LOADING_ANIMATION_FINISH_DELAY=500;AVOID_INSTANT_REMOVAL_LOADER_DELAY=500;CURRENT_USER_EMAIL=wc_mercadopago_supertoken_trigger_handler_params.current_user_email;wcBuyerEmail=null;currentAmount=null;isAlreadyListeningForm=!1;lastException=null;mpSuperTokenAuthenticator=null;wcEmailListener=null;mpSuperTokenPaymentMethods=null;mpSuperTokenErrorHandler=null;constructor(e,t,o,n){this.mpSuperTokenAuthenticator=e,this.wcEmailListener=t,this.mpSuperTokenPaymentMethods=o,this.mpSuperTokenErrorHandler=n}hasLastException(){return!!this.getLastException()}getLastException(){return this.lastException}setLastException(e){this.lastException=e}getBuyerEmail(){return this.wcBuyerEmail=this.wcBuyerEmail||this.wcEmailListener.getEmail()||this.CURRENT_USER_EMAIL,this.wcBuyerEmail?.trim()}amountHasChanged(){return null!=this.currentAmount&&null!=this.mpSuperTokenAuthenticator.getAmountUsed()&&this.currentAmount!==this.mpSuperTokenAuthenticator.getAmountUsed()}isDifferentEmail(e){return this.wcBuyerEmail!=e}getCustomCheckoutRadioElement(){return document.querySelector(this.CUSTOM_CHECKOUT_BLOCKS_RADIO_SELECTOR)||document.querySelector(this.CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR)}isClassicCheckout(){return!!document.querySelector(this.CUSTOM_CHECKOUT_CLASSIC_RADIO_SELECTOR)}customCheckoutIsEnable(){return!!this.getCustomCheckoutRadioElement()}customCheckoutIsActive(){return this.getCustomCheckoutRadioElement()?.checked}resetFlow(){this.mpSuperTokenAuthenticator.reset(),this.mpSuperTokenPaymentMethods.reset()}resetCustomCheckout(e=!0){window.mpSuperTokenPaymentMethods?.hideSuperTokenError(),window.mpCustomCheckoutHandler?.cardForm?.createLoadSpinner(),this.mpSuperTokenAuthenticator?.setSuperTokenValidation(!1),this.mpSuperTokenPaymentMethods.hasStoredPaymentMethods()&&(this.mpSuperTokenPaymentMethods.unmountCardForm(),this.mpSuperTokenPaymentMethods.mountCardForm()),e&&this.resetFlow(),this.loadSuperToken(this.currentAmount).finally((()=>{setTimeout((()=>{window.mpCustomCheckoutHandler?.cardForm?.removeLoadSpinner(),this.mpSuperTokenPaymentMethods.hasCheckoutError()&&this.mpSuperTokenPaymentMethods.selectLastPaymentMethodChoosen(),this.hasLastException()&&setTimeout((()=>{this.mpSuperTokenErrorHandler.handleError(this.getLastException()),this.setLastException(null)}),this.LOADING_ANIMATION_FINISH_DELAY)}),this.AVOID_INSTANT_REMOVAL_LOADER_DELAY)}))}resetSuperTokenOnError(){if("super_token"===document.querySelector("#mp_checkout_type")?.value){const e=document.querySelector(`.${this.mpSuperTokenPaymentMethods?.SUPER_TOKEN_STYLES?.PAYMENT_METHOD_LIST}`);e&&e.scrollIntoView({behavior:"smooth"}),this.mpSuperTokenPaymentMethods.deselectAllPaymentMethods(),this.mpSuperTokenPaymentMethods.hideAllPaymentMethodDetails(),this.mpSuperTokenPaymentMethods.unmountActiveSecurityCodeInstance(),this.mpSuperTokenPaymentMethods.activePaymentMethod=null,this.resetCustomCheckout(!0)}}isSuperTokenPaymentMethodsLoaded(){return this.mpSuperTokenPaymentMethods.hasStoredPaymentMethods()}async fetchAndRenderSuperTokenPaymentMethods(){const e=this.getBuyerEmail();if(!e)return;const t=await this.mpSuperTokenAuthenticator.getAccountPaymentMethods(this.currentAmount,e);t&&t.length&&await this.mpSuperTokenPaymentMethods.renderAccountPaymentMethods(t,this.currentAmount)}async loadSuperToken(e){this.currentAmount=this.mpSuperTokenAuthenticator.formatAmount(e),this.amountHasChanged()&&this.resetFlow(),this.isSuperTokenPaymentMethodsLoaded()?this.mpSuperTokenPaymentMethods.renderAccountPaymentMethods(this.mpSuperTokenPaymentMethods.getStoredPaymentMethods(),this.currentAmount):(await this.fetchAndRenderSuperTokenPaymentMethods(),this.isAlreadyListeningForm||(this.wcEmailListener.onEmailChange((async(t,o)=>{o&&e&&this.isDifferentEmail(t)&&null!=this.wcBuyerEmail&&(this.wcBuyerEmail=t,this.resetCustomCheckout())})),this.wcEmailListener.setupEmailChangeHandlers(),this.isAlreadyListeningForm=!0))}}